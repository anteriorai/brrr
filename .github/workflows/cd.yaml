name: CD
on:
  push:
    branches:
      - master

jobs:
  publish-to-npm:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    defaults:
      run:
        working-directory: "typescript"
    steps:
      - uses: actions/checkout@v5
        with:
          # for npm-version-to-git
          fetch-depth: 0
      - uses: cachix/install-nix-action@v31
        with:
          enable_kvm: true
          extra_nix_config: "system-features = nixos-test benchmark big-parallel kvm"
      # Our private cache, feel free to substitute in a fork
      - uses: cachix/cachix-action@v16
        with:
          name: anterior-private
          signingKey: "${{ secrets.CACHIX_SIGNING_KEY }}"
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - uses: nicknovitski/nix-develop@v1.2.0
      - run: |
          npm config set registry https://registry.npmjs.org
      - run: npm ci
      - run: npm-version-to-git
      - run: |
          printf '//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}\n' > ~/.npmrc
      - run: npm run build
      - run: npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

name: CD
on:
  push:
    branches:
      - master

jobs:
  publish-to-npm:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    defaults:
      run:
        working-directory: "typescript"
    steps:
      - uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493
        with:
          # for npm-version-to-git
          fetch-depth: 0
      - uses: cachix/install-nix-action@7ab6e7fd29da88e74b1e314a4ae9ac6b5cda3801
        with:
          enable_kvm: true
          extra_nix_config: "system-features = nixos-test benchmark big-parallel kvm"
      # Our private cache, feel free to substitute in a fork
      - uses: cachix/cachix-action@ee79db531bfb851a7cf47035057b7cca88d26449
        with:
          name: anterior-private
          signingKey: "${{ secrets.CACHIX_SIGNING_KEY }}"
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - uses: nicknovitski/nix-develop@5da6ac475f1ffbcf54ee562fa3056646e146be95
      - run: |
          npm config set registry https://registry.npmjs.org
      - run: npm ci
      - run: npm-version-to-git
      - run: |
          printf '//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}\n' > ~/.npmrc
      - run: npm run build
      - run: npm publish --access public --provenance
